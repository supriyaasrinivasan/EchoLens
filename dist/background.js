/*! For license information please see background.js.LICENSE.txt */
(()=>{function t(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,s,a,o=[],u=!0,c=!1;try{if(s=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=s.call(n)).done)&&(o.push(r.value),o.length!==e);u=!0);}catch(t){c=!0,i=t}finally{try{if(!u&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw i}}return o}}(t,n)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach(function(e){s(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function s(t,e,n){return(e=p(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function a(){var t,e,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function s(n,r,i,s){var a=r&&r.prototype instanceof c?r:c,h=Object.create(a.prototype);return o(h,"_invoke",function(n,r,i){var s,a,o,c=0,h=i||[],l=!1,f={p:0,n:0,v:t,a:p,f:p.bind(t,4),d:function(e,n){return s=e,a=0,o=t,f.n=n,u}};function p(n,r){for(a=n,o=r,e=0;!l&&c&&!i&&e<h.length;e++){var i,s=h[e],p=f.p,g=s[2];n>3?(i=g===r)&&(o=s[(a=s[4])?5:(a=3,3)],s[4]=s[5]=t):s[0]<=p&&((i=n<2&&p<s[1])?(a=0,f.v=r,f.n=s[1]):p<g&&(i=n<3||s[0]>r||r>g)&&(s[4]=n,s[5]=r,f.n=g,a=0))}if(i||n>1)return u;throw l=!0,r}return function(i,h,g){if(c>1)throw TypeError("Generator is already running");for(l&&1===h&&p(h,g),a=h,o=g;(e=a<2?t:o)||!l;){s||(a?a<3?(a>1&&(f.n=-1),p(a,o)):f.n=o:f.v=o);try{if(c=2,s){if(a||(i="next"),e=s[i]){if(!(e=e.call(s,o)))throw TypeError("iterator result is not an object");if(!e.done)return e;o=e.value,a<2&&(a=0)}else 1===a&&(e=s.return)&&e.call(s),a<2&&(o=TypeError("The iterator does not provide a '"+i+"' method"),a=1);s=t}else if((e=(l=f.n<0)?o:n.call(r,f))!==u)break}catch(e){s=t,a=1,o=e}finally{c=1}}return{value:e,done:l}}}(n,i,s),!0),h}var u={};function c(){}function h(){}function l(){}e=Object.getPrototypeOf;var f=[][r]?e(e([][r]())):(o(e={},r,function(){return this}),e),p=l.prototype=c.prototype=Object.create(f);function g(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,l):(t.__proto__=l,o(t,i,"GeneratorFunction")),t.prototype=Object.create(p),t}return h.prototype=l,o(p,"constructor",l),o(l,"constructor",h),h.displayName="GeneratorFunction",o(l,i,"GeneratorFunction"),o(p),o(p,i,"Generator"),o(p,r,function(){return this}),o(p,"toString",function(){return"[object Generator]"}),(a=function(){return{w:s,m:g}})()}function o(t,e,n,r){var i=Object.defineProperty;try{i({},"",{})}catch(t){i=0}o=function(t,e,n,r){function s(e,n){o(t,e,function(t){return this._invoke(e,n,t)})}e?i?i(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n:(s("next",0),s("throw",1),s("return",2))},o(t,e,n,r)}function u(t,e,n,r,i,s,a){try{var o=t[s](a),u=o.value}catch(t){return void n(t)}o.done?e(u):Promise.resolve(u).then(r,i)}function c(t){return function(){var e=this,n=arguments;return new Promise(function(r,i){var s=t.apply(e,n);function a(t){u(s,r,i,a,o,"next",t)}function o(t){u(s,r,i,a,o,"throw",t)}a(void 0)})}}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,p(r.key),r)}}function f(t,e,n){return e&&l(t.prototype,e),n&&l(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function p(t){var e=function(t,e){if("object"!=n(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==n(e)?e:e+""}var g=function(){return f(function t(){h(this,t),this.KEYS={VISITS:"echolens_visits",HIGHLIGHTS:"echolens_highlights",INSIGHTS:"echolens_insights",TAGS:"echolens_tags",SETTINGS:"echolens_settings"}},[{key:"get",value:(S=c(a().m(function t(e){return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.get([e],function(n){t(n[e]||null)})}))},t)})),function(t){return S.apply(this,arguments)})},{key:"set",value:(d=c(a().m(function t(e,n){return a().w(function(t){for(;;)if(0===t.n)return t.a(2,new Promise(function(t){chrome.storage.local.set(s({},e,n),function(){t()})}))},t)})),function(t,e){return d.apply(this,arguments)})},{key:"updateVisit",value:(b=c(a().m(function t(e){var n,r,i,s,o,u,c,h,l;return a().w(function(t){for(;;)switch(t.n){case 0:return n=e.url,r=e.title,e.content,i=e.timeSpent,s=e.scrollDepth,o=e.interactions,u=e.highlights,t.n=1,this.get(this.KEYS.VISITS);case 1:if(l=t.v){t.n=2;break}l={};case 2:return c=l,h=this.hashURL(n),c[h]||(c[h]={url:n,title:r,firstVisit:Date.now(),visits:0,totalTimeSpent:0,sessions:[]}),c[h].visits+=1,c[h].totalTimeSpent+=i,c[h].lastVisit=Date.now(),c[h].title=r,c[h].sessions.push({timestamp:Date.now(),timeSpent:i,scrollDepth:s,interactions:o,highlightCount:(null==u?void 0:u.length)||0}),c[h].sessions.length>50&&(c[h].sessions=c[h].sessions.slice(-50)),t.n=3,this.set(this.KEYS.VISITS,c);case 3:return t.a(2)}},t,this)})),function(t){return b.apply(this,arguments)})},{key:"getVisitHistory",value:(y=c(a().m(function t(e){var n,r,i;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.VISITS);case 1:if(i=t.v){t.n=2;break}i={};case 2:return n=i,r=this.hashURL(e),t.a(2,n[r]||null)}},t,this)})),function(t){return y.apply(this,arguments)})},{key:"saveHighlight",value:(m=c(a().m(function t(e){var n,r,i,s,o,u,c;return a().w(function(t){for(;;)switch(t.n){case 0:return n=e.text,r=e.url,i=e.title,s=e.timestamp,t.n=1,this.get(this.KEYS.HIGHLIGHTS);case 1:if(c=t.v){t.n=2;break}c={};case 2:return o=c,u=this.hashURL(r),o[u]||(o[u]={url:r,title:i,items:[]}),o[u].items.push({text:n,timestamp:s}),o[u].items.length>100&&(o[u].items=o[u].items.slice(-100)),t.n=3,this.set(this.KEYS.HIGHLIGHTS,o);case 3:return t.a(2)}},t,this)})),function(t){return m.apply(this,arguments)})},{key:"getHighlights",value:(v=c(a().m(function t(e){var n,r,i,s;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.HIGHLIGHTS);case 1:if(s=t.v){t.n=2;break}s={};case 2:return r=s,i=this.hashURL(e),t.a(2,(null===(n=r[i])||void 0===n?void 0:n.items)||[])}},t,this)})),function(t){return v.apply(this,arguments)})},{key:"saveAIInsights",value:(g=c(a().m(function t(e,n){var r,s,o;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.INSIGHTS);case 1:if(o=t.v){t.n=2;break}o={};case 2:return r=o,s=this.hashURL(e),r[s]=i({url:e},n),t.n=3,this.set(this.KEYS.INSIGHTS,r);case 3:return t.a(2)}},t,this)})),function(t,e){return g.apply(this,arguments)})},{key:"getAIInsights",value:(p=c(a().m(function t(e){var n,r,i;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.INSIGHTS);case 1:if(i=t.v){t.n=2;break}i={};case 2:return n=i,r=this.hashURL(e),t.a(2,n[r]||null)}},t,this)})),function(t){return p.apply(this,arguments)})},{key:"addTag",value:(l=c(a().m(function t(e,n){var r,i,s;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.TAGS);case 1:if(s=t.v){t.n=2;break}s={};case 2:return r=s,i=this.hashURL(e),r[i]||(r[i]={url:e,tags:[]}),r[i].tags.includes(n)||r[i].tags.push(n),t.n=3,this.set(this.KEYS.TAGS,r);case 3:return t.a(2)}},t,this)})),function(t,e){return l.apply(this,arguments)})},{key:"getMemories",value:(u=c(a().m(function t(){var e,n,r,i,s,o,u,c,h,l,f,p=arguments;return a().w(function(t){for(;;)switch(t.n){case 0:return e=p.length>0&&void 0!==p[0]?p[0]:{},t.n=1,this.get(this.KEYS.VISITS);case 1:if(c=t.v){t.n=2;break}c={};case 2:return n=c,t.n=3,this.get(this.KEYS.HIGHLIGHTS);case 3:if(h=t.v){t.n=4;break}h={};case 4:return r=h,t.n=5,this.get(this.KEYS.INSIGHTS);case 5:if(l=t.v){t.n=6;break}l={};case 6:return i=l,t.n=7,this.get(this.KEYS.TAGS);case 7:if(f=t.v){t.n=8;break}f={};case 8:return s=f,o=Object.keys(n).map(function(t){var e,a,o=n[t];return{url:o.url,title:o.title,visits:o.visits,lastVisit:o.lastVisit,firstVisit:o.firstVisit,totalTimeSpent:o.totalTimeSpent,highlights:(null===(e=r[t])||void 0===e?void 0:e.items)||[],insights:i[t]||null,tags:(null===(a=s[t])||void 0===a?void 0:a.tags)||[],sessions:o.sessions}}),u=o,e.minVisits&&(u=u.filter(function(t){return t.visits>=e.minVisits})),e.minTimeSpent&&(u=u.filter(function(t){return t.totalTimeSpent>=e.minTimeSpent})),e.tag&&(u=u.filter(function(t){return t.tags.includes(e.tag)})),e.dateFrom&&(u=u.filter(function(t){return t.lastVisit>=e.dateFrom})),u.sort(function(t,e){return e.lastVisit-t.lastVisit}),t.a(2,u)}},t,this)})),function(){return u.apply(this,arguments)})},{key:"getAllMemories",value:(o=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.getMemories();case 1:return t.a(2,t.v)}},t,this)})),function(){return o.apply(this,arguments)})},{key:"getStats",value:(r=c(a().m(function t(){var e,n,r,i,s,o,u,c,h,l;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.VISITS);case 1:if(h=t.v){t.n=2;break}h={};case 2:return e=h,t.n=3,this.get(this.KEYS.HIGHLIGHTS);case 3:if(l=t.v){t.n=4;break}l={};case 4:return n=l,r=Object.keys(e).length,i=Object.values(e).reduce(function(t,e){return t+e.totalTimeSpent},0),s=Object.values(n).reduce(function(t,e){return t+e.items.length},0),o=Object.values(e).reduce(function(t,e){return t+e.visits},0),u=Date.now()-6048e5,c=Object.values(e).filter(function(t){return t.lastVisit>=u}).length,t.a(2,{totalVisits:r,totalTimeSpent:i,totalHighlights:s,totalSessions:o,thisWeekVisits:c,averageTimePerVisit:o>0?Math.floor(i/o):0})}},t,this)})),function(){return r.apply(this,arguments)})},{key:"cleanup",value:(n=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:console.log("Cleanup would happen here for free tier users");case 1:return t.a(2)}},t)})),function(){return n.apply(this,arguments)})},{key:"hashURL",value:function(t){return t.replace(/[^a-zA-Z0-9]/g,"_").substring(0,100)}},{key:"exportData",value:(e=c(a().m(function t(){var e,n,r,i,s,o,u,c,h,l;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.get(this.KEYS.VISITS);case 1:if(o=t.v){t.n=2;break}o={};case 2:return e=o,t.n=3,this.get(this.KEYS.HIGHLIGHTS);case 3:if(u=t.v){t.n=4;break}u={};case 4:return n=u,t.n=5,this.get(this.KEYS.INSIGHTS);case 5:if(c=t.v){t.n=6;break}c={};case 6:return r=c,t.n=7,this.get(this.KEYS.TAGS);case 7:if(h=t.v){t.n=8;break}h={};case 8:return i=h,t.n=9,this.get(this.KEYS.SETTINGS);case 9:if(l=t.v){t.n=10;break}l={};case 10:return s=l,t.a(2,{visits:e,highlights:n,insights:r,tags:i,settings:s,exportDate:Date.now()})}},t,this)})),function(){return e.apply(this,arguments)})},{key:"importData",value:(t=c(a().m(function t(e){return a().w(function(t){for(;;)switch(t.n){case 0:if(!e.visits){t.n=1;break}return t.n=1,this.set(this.KEYS.VISITS,e.visits);case 1:if(!e.highlights){t.n=2;break}return t.n=2,this.set(this.KEYS.HIGHLIGHTS,e.highlights);case 2:if(!e.insights){t.n=3;break}return t.n=3,this.set(this.KEYS.INSIGHTS,e.insights);case 3:if(!e.tags){t.n=4;break}return t.n=4,this.set(this.KEYS.TAGS,e.tags);case 4:if(!e.settings){t.n=5;break}return t.n=5,this.set(this.KEYS.SETTINGS,e.settings);case 5:return t.a(2)}},t,this)})),function(e){return t.apply(this,arguments)})}]);var t,e,n,r,o,u,l,p,g,v,m,y,b,d,S}(),v=function(){return f(function t(){h(this,t),this.apiKey=null,this.provider="openai",this.loadConfig()},[{key:"loadConfig",value:(u=c(a().m(function t(){var e=this;return a().w(function(t){for(;;)switch(t.n){case 0:chrome.storage.local.get(["ai_api_key","ai_provider"],function(t){e.apiKey=t.ai_api_key||null,e.provider=t.ai_provider||"openai"});case 1:return t.a(2)}},t)})),function(){return u.apply(this,arguments)})},{key:"generateSummary",value:(o=c(a().m(function t(e){var n;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.apiKey){t.n=1;break}return console.warn("No AI API key configured"),t.a(2,this.generateFallbackSummary(e));case 1:if(t.p=1,"openai"!==this.provider){t.n=3;break}return t.n=2,this.openAISummary(e);case 2:case 4:return t.a(2,t.v);case 3:if("anthropic"!==this.provider){t.n=5;break}return t.n=4,this.anthropicSummary(e);case 5:t.n=7;break;case 6:return t.p=6,n=t.v,console.error("AI summary error:",n),t.a(2,this.generateFallbackSummary(e));case 7:return t.a(2)}},t,this,[[1,6]])})),function(t){return o.apply(this,arguments)})},{key:"openAISummary",value:(s=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.apiKey)},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"You are a concise summarizer. Create a 1-2 sentence summary of the following content that captures the main topic and purpose."},{role:"user",content:e.substring(0,3e3)}],max_tokens:100,temperature:.5})});case 1:return n=t.v,t.n=2,n.json();case 2:return r=t.v,t.a(2,r.choices[0].message.content.trim())}},t,this)})),function(t){return s.apply(this,arguments)})},{key:"predictTags",value:(i=c(a().m(function t(e,n){var r;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.apiKey){t.n=1;break}return t.a(2,this.generateFallbackTags(e,n));case 1:if(t.p=1,"openai"!==this.provider){t.n=3;break}return t.n=2,this.openAITags(e,n);case 2:return t.a(2,t.v);case 3:t.n=5;break;case 4:return t.p=4,r=t.v,console.error("AI tagging error:",r),t.a(2,this.generateFallbackTags(e,n));case 5:return t.a(2)}},t,this,[[1,4]])})),function(t,e){return i.apply(this,arguments)})},{key:"openAITags",value:(r=c(a().m(function t(e,n){var r,i,s;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.apiKey)},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"Generate 3-5 relevant tags for this content. Return only the tags separated by commas, like: learning, ai, research"},{role:"user",content:"Title: ".concat(n,"\n\nContent: ").concat(e.substring(0,2e3))}],max_tokens:50,temperature:.7})});case 1:return r=t.v,t.n=2,r.json();case 2:return i=t.v,s=i.choices[0].message.content.trim().split(",").map(function(t){return t.trim()}),t.a(2,s.slice(0,5))}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"extractTopics",value:(n=c(a().m(function t(e){var n;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.apiKey){t.n=1;break}return t.a(2,this.generateFallbackTopics(e));case 1:if(t.p=1,"openai"!==this.provider){t.n=3;break}return t.n=2,this.openAITopics(e);case 2:return t.a(2,t.v);case 3:t.n=5;break;case 4:return t.p=4,n=t.v,console.error("AI topic extraction error:",n),t.a(2,this.generateFallbackTopics(e));case 5:return t.a(2)}},t,this,[[1,4]])})),function(t){return n.apply(this,arguments)})},{key:"openAITopics",value:(e=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.apiKey)},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"Extract 3-5 key topics or concepts from this content. Return only the topics separated by commas."},{role:"user",content:e.substring(0,2e3)}],max_tokens:60,temperature:.5})});case 1:return n=t.v,t.n=2,n.json();case 2:return r=t.v,t.a(2,r.choices[0].message.content.trim().split(",").map(function(t){return t.trim()}))}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"generateFallbackSummary",value:function(t){return t.split(/[.!?]+/).filter(function(t){return t.trim().length>20}).slice(0,2).join(". ").substring(0,200)+"..."}},{key:"generateFallbackTags",value:function(e,n){var r=(n+" "+e).toLowerCase(),i=["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","is","was","are","were","been","be","have","has","had","do","does","did","will","would","could","should","may","might","can","this","that","these","those"],s=r.split(/\W+/).filter(function(t){return t.length>3&&!i.includes(t)&&!/^\d+$/.test(t)}),a={};return s.forEach(function(t){return a[t]=(a[t]||0)+1}),Object.entries(a).sort(function(t,e){return e[1]-t[1]}).slice(0,5).map(function(e){return t(e,1)[0]})}},{key:"generateFallbackTopics",value:function(t){return this.generateFallbackTags(t,"")}}]);var e,n,r,i,s,o,u}();new(function(){return f(function t(){h(this,t),this.storage=new g,this.ai=new v,this.activeSessions=new Map,this.init()},[{key:"init",value:function(){var t=this;chrome.runtime.onMessage.addListener(function(e,n,r){return t.handleMessage(e,n,r),!0}),chrome.tabs.onUpdated.addListener(function(e,n,r){"complete"===n.status&&t.handleTabLoad(e,r)}),chrome.tabs.onRemoved.addListener(function(e){t.handleTabClose(e)}),chrome.alarms.create("cleanup",{periodInMinutes:60}),chrome.alarms.onAlarm.addListener(function(e){"cleanup"===e.name&&t.performCleanup()}),console.log("ðŸŒŒ EchoLens Background Service Worker initialized")}},{key:"handleMessage",value:(S=c(a().m(function t(e,n,r){var i,s,o,u,c,h,l,f,p,g;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:i=e.type,s=e.data,o=e.url,t.p=1,p=i,t.n="CONTEXT_UPDATE"===p?2:"SAVE_HIGHLIGHT"===p?4:"GET_PREVIOUS_CONTEXT"===p?6:"PAGE_UNLOAD"===p?8:"GET_MEMORIES"===p?10:"SEARCH_MEMORIES"===p?12:"ADD_TAG"===p?14:"GET_STATS"===p?16:"EXPORT_DATA"===p?18:"IMPORT_DATA"===p?20:22;break;case 2:return t.n=3,this.handleContextUpdate(s,n.tab);case 3:return r({success:!0}),t.a(3,23);case 4:return t.n=5,this.saveHighlight(s);case 5:return r({success:!0}),t.a(3,23);case 6:return t.n=7,this.getPreviousContext(o);case 7:return u=t.v,r({context:u}),t.a(3,23);case 8:return t.n=9,this.handlePageUnload(s,n.tab);case 9:return r({success:!0}),t.a(3,23);case 10:return t.n=11,this.getMemories(s);case 11:return c=t.v,r({memories:c}),t.a(3,23);case 12:return t.n=13,this.searchMemories(s.query);case 13:return h=t.v,r({results:h}),t.a(3,23);case 14:return t.n=15,this.addTag(s.url,s.tag);case 15:return r({success:!0}),t.a(3,23);case 16:return t.n=17,this.getStats();case 17:return l=t.v,r({stats:l}),t.a(3,23);case 18:return t.n=19,this.exportData();case 19:return f=t.v,r({data:f}),t.a(3,23);case 20:return t.n=21,this.importData(s);case 21:return r({success:!0}),t.a(3,23);case 22:r({error:"Unknown message type"});case 23:t.n=25;break;case 24:t.p=24,g=t.v,console.error("Error handling message:",g),r({error:g.message});case 25:return t.a(2)}},t,this,[[1,24]])})),function(t,e,n){return S.apply(this,arguments)})},{key:"handleContextUpdate",value:(d=c(a().m(function t(e,n){var r,i,s,o;return a().w(function(t){for(;;)switch(t.n){case 0:if(r=e.url,i=e.title,e.content,!((s=e.timeSpent)<10)){t.n=1;break}return t.a(2);case 1:if((o=this.activeSessions.get(n.id))||(o={url:r,title:i,startTime:Date.now(),tabId:n.id},this.activeSessions.set(n.id,o)),o.lastUpdate=Date.now(),o.context=e,!(s>30)||o.aiProcessed){t.n=2;break}return o.aiProcessed=!0,t.n=2,this.processWithAI(e);case 2:return t.n=3,this.storage.updateVisit(e);case 3:return t.a(2)}},t,this)})),function(t,e){return d.apply(this,arguments)})},{key:"processWithAI",value:(b=c(a().m(function t(e){var n,r,i,s;return a().w(function(t){for(;;)switch(t.p=t.n){case 0:return t.p=0,t.n=1,this.ai.generateSummary(e.content);case 1:return n=t.v,t.n=2,this.ai.predictTags(e.content,e.title);case 2:return r=t.v,t.n=3,this.ai.extractTopics(e.content);case 3:return i=t.v,t.n=4,this.storage.saveAIInsights(e.url,{summary:n,tags:r,topics:i,timestamp:Date.now()});case 4:console.log("âœ¨ AI processing complete for:",e.url),t.n=6;break;case 5:t.p=5,s=t.v,console.error("AI processing error:",s);case 6:return t.a(2)}},t,this,[[0,5]])})),function(t){return b.apply(this,arguments)})},{key:"handleTabLoad",value:(y=c(a().m(function t(e,n){var r;return a().w(function(t){for(;;)switch(t.n){case 0:if(n.url&&!n.url.startsWith("chrome://")){t.n=1;break}return t.a(2);case 1:return t.n=2,this.storage.getVisitHistory(n.url);case 2:(r=t.v)&&r.visits>0&&console.log("ðŸ”® Returning user to: ".concat(n.url," (").concat(r.visits," previous visits)"));case 3:return t.a(2)}},t,this)})),function(t,e){return y.apply(this,arguments)})},{key:"handleTabClose",value:(m=c(a().m(function t(e){var n;return a().w(function(t){for(;;)switch(t.n){case 0:if(!(n=this.activeSessions.get(e))||!n.context){t.n=2;break}return t.n=1,this.storage.updateVisit(n.context);case 1:this.activeSessions.delete(e);case 2:return t.a(2)}},t,this)})),function(t){return m.apply(this,arguments)})},{key:"handlePageUnload",value:(p=c(a().m(function t(e,n){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.updateVisit(e);case 1:this.activeSessions.delete(n.id);case 2:return t.a(2)}},t,this)})),function(t,e){return p.apply(this,arguments)})},{key:"saveHighlight",value:(l=c(a().m(function t(e){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.saveHighlight(e);case 1:return t.a(2)}},t,this)})),function(t){return l.apply(this,arguments)})},{key:"getPreviousContext",value:(u=c(a().m(function t(e){var n,r,i;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.getVisitHistory(e);case 1:return n=t.v,t.n=2,this.storage.getHighlights(e);case 2:return r=t.v,t.n=3,this.storage.getAIInsights(e);case 3:if(i=t.v,n){t.n=4;break}return t.a(2,null);case 4:return t.a(2,{visits:n.visits||0,lastVisit:n.lastVisit,totalTimeSpent:n.totalTimeSpent||0,highlights:r.slice(0,5),tags:(null==i?void 0:i.tags)||[],summary:null==i?void 0:i.summary})}},t,this)})),function(t){return u.apply(this,arguments)})},{key:"getMemories",value:(o=c(a().m(function t(){var e,n=arguments;return a().w(function(t){for(;;)switch(t.n){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{},t.n=1,this.storage.getMemories(e);case 1:return t.a(2,t.v)}},t,this)})),function(){return o.apply(this,arguments)})},{key:"searchMemories",value:(s=c(a().m(function t(e){var n,r;return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.getAllMemories();case 1:return n=t.v,r=n.filter(function(t){var n;return"".concat(t.title," ").concat(t.content," ").concat(null===(n=t.highlights)||void 0===n?void 0:n.join(" ")).toLowerCase().includes(e.toLowerCase())}),t.a(2,r.sort(function(t,n){var r=(t.title+t.content).toLowerCase().split(e.toLowerCase()).length;return(n.title+n.content).toLowerCase().split(e.toLowerCase()).length-r}))}},t,this)})),function(t){return s.apply(this,arguments)})},{key:"addTag",value:(i=c(a().m(function t(e,n){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.addTag(e,n);case 1:return t.a(2)}},t,this)})),function(t,e){return i.apply(this,arguments)})},{key:"getStats",value:(r=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.getStats();case 1:return t.a(2,t.v)}},t,this)})),function(){return r.apply(this,arguments)})},{key:"exportData",value:(n=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.exportData();case 1:return t.a(2,t.v)}},t,this)})),function(){return n.apply(this,arguments)})},{key:"importData",value:(e=c(a().m(function t(e){return a().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,this.storage.importData(e);case 1:return t.a(2,t.v)}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"performCleanup",value:(t=c(a().m(function t(){return a().w(function(t){for(;;)switch(t.n){case 0:return console.log("ðŸ§¹ Performing cleanup..."),t.n=1,this.storage.cleanup();case 1:return t.a(2)}},t,this)})),function(){return t.apply(this,arguments)})}]);var t,e,n,r,i,s,o,u,l,p,m,y,b,d,S}())})();