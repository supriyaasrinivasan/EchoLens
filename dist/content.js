/*! For license information please see content.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(){var t,o,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function c(e,r,i,a){var c=r&&r.prototype instanceof l?r:l,u=Object.create(c.prototype);return n(u,"_invoke",function(e,n,r){var i,a,c,l=0,u=r||[],h=!1,v={p:0,n:0,v:t,a:f,f:f.bind(t,4),d:function(e,n){return i=e,a=0,c=t,v.n=n,s}};function f(e,n){for(a=e,c=n,o=0;!h&&l&&!r&&o<u.length;o++){var r,i=u[o],f=v.p,d=i[2];e>3?(r=d===n)&&(c=i[(a=i[4])?5:(a=3,3)],i[4]=i[5]=t):i[0]<=f&&((r=e<2&&f<i[1])?(a=0,v.v=n,v.n=i[1]):f<d&&(r=e<3||i[0]>n||n>d)&&(i[4]=e,i[5]=n,v.n=d,a=0))}if(r||e>1)return s;throw h=!0,n}return function(r,u,d){if(l>1)throw TypeError("Generator is already running");for(h&&1===u&&f(u,d),a=u,c=d;(o=a<2?t:c)||!h;){i||(a?a<3?(a>1&&(v.n=-1),f(a,c)):v.n=c:v.v=c);try{if(l=2,i){if(a||(r="next"),o=i[r]){if(!(o=o.call(i,c)))throw TypeError("iterator result is not an object");if(!o.done)return o;c=o.value,a<2&&(a=0)}else 1===a&&(o=i.return)&&o.call(i),a<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),a=1);i=t}else if((o=(h=v.n<0)?c:e.call(n,v))!==s)break}catch(e){i=t,a=1,c=e}finally{l=1}}return{value:o,done:h}}}(e,i,a),!0),u}var s={};function l(){}function u(){}function h(){}o=Object.getPrototypeOf;var v=[][i]?o(o([][i]())):(n(o={},i,function(){return this}),o),f=h.prototype=l.prototype=Object.create(v);function d(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,n(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return u.prototype=h,n(f,"constructor",h),n(h,"constructor",u),u.displayName="GeneratorFunction",n(h,a,"GeneratorFunction"),n(f),n(f,a,"Generator"),n(f,i,function(){return this}),n(f,"toString",function(){return"[object Generator]"}),(e=function(){return{w:c,m:d}})()}function n(t,e,o,r){var i=Object.defineProperty;try{i({},"",{})}catch(t){i=0}n=function(t,e,o,r){function a(e,o){n(t,e,function(t){return this._invoke(e,o,t)})}e?i?i(t,e,{value:o,enumerable:!r,configurable:!r,writable:!r}):t[e]=o:(a("next",0),a("throw",1),a("return",2))},n(t,e,o,r)}function o(t,e,n,o,r,i,a){try{var c=t[i](a),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(o,r)}function r(t){return function(){var e=this,n=arguments;return new Promise(function(r,i){var a=t.apply(e,n);function c(t){o(a,r,i,c,s,"next",t)}function s(t){o(a,r,i,c,s,"throw",t)}c(void 0)})}}function i(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,a(o.key),o)}}function a(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,"string");if("object"!=t(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}var c=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.startTime=Date.now(),this.highlights=[],this.scrollDepth=0,this.interactions=0,this.idleTime=0,this.lastActivity=Date.now(),this.isActive=!0,this.init()},n=[{key:"init",value:function(){var t=this;this.trackScrolling(),this.trackHighlights(),this.trackActivity(),this.trackIdle(),this.injectOverlay(),this.loadPreviousContext(),setInterval(function(){return t.sendHeartbeat()},3e4)}},{key:"trackScrolling",value:function(){var t=this,e=0;window.addEventListener("scroll",function(){t.lastActivity=Date.now();var n=window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100;e=Math.max(e,n),t.scrollDepth=Math.round(e)})}},{key:"trackHighlights",value:function(){var t=this;document.addEventListener("mouseup",function(){t.lastActivity=Date.now();var e=window.getSelection(),n=e.toString().trim();n.length>10&&n.length<1e3&&(t.highlights.push({text:n,timestamp:Date.now(),context:t.getTextContext(e)}),t.saveHighlight(n))})}},{key:"trackActivity",value:function(){var t=this;["click","keydown","mousemove"].forEach(function(e){document.addEventListener(e,function(){t.lastActivity=Date.now(),"click"!==e&&"keydown"!==e||t.interactions++})})}},{key:"trackIdle",value:function(){var t=this;setInterval(function(){var e=Date.now()-t.lastActivity;t.isActive=!(e>6e4)},5e3)}},{key:"getTextContext",value:function(t){try{var e=t.getRangeAt(0).commonAncestorContainer;return(3===e.nodeType?e.parentNode:e).textContent.substring(0,500)}catch(t){return""}}},{key:"extractPageContext",value:function(){for(var t,e=document.title,n=window.location.href,o=window.location.hostname,r="",i=0,a=["article","main",'[role="main"]',".content",".post-content","#content"];i<a.length;i++){var c=a[i],s=document.querySelector(c);if(s){r=s.innerText.substring(0,5e3);break}}return r||(r=document.body.innerText.substring(0,5e3)),{title:e,url:n,domain:o,content:r,description:(null===(t=document.querySelector('meta[name="description"]'))||void 0===t?void 0:t.content)||"",headings:Array.from(document.querySelectorAll("h1, h2, h3")).slice(0,10).map(function(t){return t.innerText.trim()}),timestamp:Date.now(),timeSpent:Math.floor((Date.now()-this.startTime)/1e3),scrollDepth:this.scrollDepth,interactions:this.interactions,highlights:this.highlights}}},{key:"sendHeartbeat",value:(c=r(e().m(function t(){var n;return e().w(function(t){for(;;)switch(t.n){case 0:if(this.isActive){t.n=1;break}return t.a(2);case 1:n=this.extractPageContext(),chrome.runtime.sendMessage({type:"CONTEXT_UPDATE",data:n});case 2:return t.a(2)}},t,this)})),function(){return c.apply(this,arguments)})},{key:"saveHighlight",value:(a=r(e().m(function t(n){return e().w(function(t){for(;;)switch(t.n){case 0:chrome.runtime.sendMessage({type:"SAVE_HIGHLIGHT",data:{text:n,url:window.location.href,title:document.title,timestamp:Date.now()}});case 1:return t.a(2)}},t)})),function(t){return a.apply(this,arguments)})},{key:"loadPreviousContext",value:(o=r(e().m(function t(){var n=this;return e().w(function(t){for(;;)switch(t.n){case 0:chrome.runtime.sendMessage({type:"GET_PREVIOUS_CONTEXT",url:window.location.href},function(t){t&&t.context&&n.showMemoryOverlay(t.context)});case 1:return t.a(2)}},t)})),function(){return o.apply(this,arguments)})},{key:"injectOverlay",value:function(){var t=document.createElement("div");t.id="echolens-overlay",t.innerHTML='\n      <div class="echolens-icon" title="EchoLens Memory">\n        ðŸ’«\n      </div>\n      <div class="echolens-popup" style="display: none;">\n        <div class="echolens-popup-content">\n          <div class="echolens-loading">Loading memories...</div>\n        </div>\n      </div>\n    ',document.body.appendChild(t);var e=t.querySelector(".echolens-icon"),n=t.querySelector(".echolens-popup");e.addEventListener("click",function(){var t="none"!==n.style.display;n.style.display=t?"none":"block"})}},{key:"showMemoryOverlay",value:function(t){var e=document.querySelector(".echolens-popup-content");if(e){var n=t.visits,o=t.lastVisit,r=t.totalTimeSpent,i=t.highlights,a=t.tags,c='<div class="echolens-memory">';if(n>1){if(c+='\n        <div class="memory-header">\n          <span class="memory-icon">ðŸ”®</span>\n          <span class="memory-title">Memory Recall</span>\n        </div>\n        <div class="memory-stat">\n          You\'ve been here <strong>'.concat(n," times</strong>\n        </div>\n      "),o){var s=this.formatTimeSince(o);c+='<div class="memory-stat">Last visit: <strong>'.concat(s,"</strong></div>")}if(r>60){var l=Math.floor(r/60);c+='<div class="memory-stat">Total time: <strong>'.concat(l," minutes</strong></div>")}i&&i.length>0&&(c+='<div class="memory-section">',c+='<div class="memory-section-title">Your highlights:</div>',i.slice(0,3).forEach(function(t){c+='<div class="memory-highlight">"'.concat(t.text.substring(0,100),'..."</div>')}),c+="</div>"),a&&a.length>0&&(c+='<div class="memory-section">',c+='<div class="memory-tags">',a.forEach(function(t){c+='<span class="memory-tag">'.concat(t,"</span>")}),c+="</div></div>")}else c+='\n        <div class="memory-header">\n          <span class="memory-icon">âœ¨</span>\n          <span class="memory-title">First Visit</span>\n        </div>\n        <div class="memory-stat">\n          This is your first time here. EchoLens is capturing context...\n        </div>\n      ';c+="</div>",e.innerHTML=c}}},{key:"formatTimeSince",value:function(t){var e=Math.floor((Date.now()-t)/1e3);return e<60?"just now":e<3600?"".concat(Math.floor(e/60)," minutes ago"):e<86400?"".concat(Math.floor(e/3600)," hours ago"):e<604800?"".concat(Math.floor(e/86400)," days ago"):e<2592e3?"".concat(Math.floor(e/604800)," weeks ago"):"".concat(Math.floor(e/2592e3)," months ago")}}],n&&i(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,o,a,c}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){new c}):new c,window.addEventListener("beforeunload",function(){var t=(window.contextCapture||new c).extractPageContext();chrome.runtime.sendMessage({type:"PAGE_UNLOAD",data:t})})})();