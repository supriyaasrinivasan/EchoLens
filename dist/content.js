/*! For license information please see content.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(){var t,o,i="function"==typeof Symbol?Symbol:{},r=i.iterator||"@@iterator",a=i.toStringTag||"@@toStringTag";function c(e,i,r,a){var c=i&&i.prototype instanceof u?i:u,l=Object.create(c.prototype);return n(l,"_invoke",function(e,n,i){var r,a,c,u=0,l=i||[],d=!1,v={p:0,n:0,v:t,a:m,f:m.bind(t,4),d:function(e,n){return r=e,a=0,c=t,v.n=n,s}};function m(e,n){for(a=e,c=n,o=0;!d&&u&&!i&&o<l.length;o++){var i,r=l[o],m=v.p,f=r[2];e>3?(i=f===n)&&(c=r[(a=r[4])?5:(a=3,3)],r[4]=r[5]=t):r[0]<=m&&((i=e<2&&m<r[1])?(a=0,v.v=n,v.n=r[1]):m<f&&(i=e<3||r[0]>n||n>f)&&(r[4]=e,r[5]=n,v.n=f,a=0))}if(i||e>1)return s;throw d=!0,n}return function(i,l,f){if(u>1)throw TypeError("Generator is already running");for(d&&1===l&&m(l,f),a=l,c=f;(o=a<2?t:c)||!d;){r||(a?a<3?(a>1&&(v.n=-1),m(a,c)):v.n=c:v.v=c);try{if(u=2,r){if(a||(i="next"),o=r[i]){if(!(o=o.call(r,c)))throw TypeError("iterator result is not an object");if(!o.done)return o;c=o.value,a<2&&(a=0)}else 1===a&&(o=r.return)&&o.call(r),a<2&&(c=TypeError("The iterator does not provide a '"+i+"' method"),a=1);r=t}else if((o=(d=v.n<0)?c:e.call(n,v))!==s)break}catch(e){r=t,a=1,c=e}finally{u=1}}return{value:o,done:d}}}(e,r,a),!0),l}var s={};function u(){}function l(){}function d(){}o=Object.getPrototypeOf;var v=[][r]?o(o([][r]())):(n(o={},r,function(){return this}),o),m=d.prototype=u.prototype=Object.create(v);function f(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,d):(t.__proto__=d,n(t,a,"GeneratorFunction")),t.prototype=Object.create(m),t}return l.prototype=d,n(m,"constructor",d),n(d,"constructor",l),l.displayName="GeneratorFunction",n(d,a,"GeneratorFunction"),n(m),n(m,a,"Generator"),n(m,r,function(){return this}),n(m,"toString",function(){return"[object Generator]"}),(e=function(){return{w:c,m:f}})()}function n(t,e,o,i){var r=Object.defineProperty;try{r({},"",{})}catch(t){r=0}n=function(t,e,o,i){function a(e,o){n(t,e,function(t){return this._invoke(e,o,t)})}e?r?r(t,e,{value:o,enumerable:!i,configurable:!i,writable:!i}):t[e]=o:(a("next",0),a("throw",1),a("return",2))},n(t,e,o,i)}function o(t,e,n,o,i,r,a){try{var c=t[r](a),s=c.value}catch(t){return void n(t)}c.done?e(s):Promise.resolve(s).then(o,i)}function i(t){return function(){var e=this,n=arguments;return new Promise(function(i,r){var a=t.apply(e,n);function c(t){o(a,i,r,c,s,"next",t)}function s(t){o(a,i,r,c,s,"throw",t)}c(void 0)})}}function r(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,a(o.key),o)}}function a(e){var n=function(e,n){if("object"!=t(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,n||"default");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==t(n)?n:n+""}var c=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.startTime=Date.now(),this.highlights=[],this.scrollDepth=0,this.interactions=0,this.idleTime=0,this.lastActivity=Date.now(),this.isActive=!0,this.focusModeActive=!1,this.init()},n=[{key:"init",value:function(){var t=this;this.trackScrolling(),this.trackHighlights(),this.trackActivity(),this.trackIdle(),this.injectOverlay(),this.loadPreviousContext(),setInterval(function(){return t.sendHeartbeat()},3e4),this.setupFocusModeListener()}},{key:"setupFocusModeListener",value:function(){var t=this;chrome.runtime.onMessage.addListener(function(e,n,o){return"FOCUS_MODE_ACTIVATED"===e.type?(t.activateFocusMode(e.duration),o({success:!0})):"FOCUS_MODE_DEACTIVATED"===e.type&&(t.deactivateFocusMode(),o({success:!0})),!0})}},{key:"activateFocusMode",value:function(t){var e=this;if(!this.focusModeActive){this.focusModeActive=!0;var n=document.createElement("div");n.id="supriai-focus-overlay",n.className="supriai-focus-mode";var o=Date.now()+t,i=Math.floor(t/6e4);n.innerHTML='\n      <div class="focus-mode-banner">\n        <div class="focus-mode-icon">ðŸŽ¯</div>\n        <div class="focus-mode-info">\n          <div class="focus-mode-title">Focus Mode Active</div>\n          <div class="focus-mode-timer" data-end="'.concat(o,'">').concat(i,':00</div>\n        </div>\n        <button class="focus-mode-exit" title="Exit Focus Mode">Ã—</button>\n      </div>\n    '),document.body.appendChild(n);var r=document.createElement("div");r.id="supriai-dim-overlay",r.className="supriai-dim",document.body.appendChild(r),document.body.classList.add("supriai-focused");var a=setInterval(function(){var t=o-Date.now();if(t<=0)clearInterval(a),e.deactivateFocusMode(),e.showFocusComplete();else{var n=Math.floor(t/6e4),i=Math.floor(t%6e4/1e3),r=document.querySelector(".focus-mode-timer");r&&(r.textContent="".concat(n,":").concat(i.toString().padStart(2,"0")))}},1e3);n.querySelector(".focus-mode-exit").addEventListener("click",function(){clearInterval(a),e.deactivateFocusMode(),chrome.runtime.sendMessage({type:"DEACTIVATE_FOCUS_MODE"})}),this.showNotification("ðŸŽ¯ Focus Mode Activated","Stay focused for ".concat(i," minutes"))}}},{key:"deactivateFocusMode",value:function(){if(this.focusModeActive){this.focusModeActive=!1;var t=document.getElementById("supriai-focus-overlay"),e=document.getElementById("supriai-dim-overlay");t&&t.remove(),e&&e.remove(),document.body.classList.remove("supriai-focused")}}},{key:"showFocusComplete",value:function(){this.showNotification("âœ… Focus Session Complete!","Great work! Take a short break.")}},{key:"showNotification",value:function(t,e){var n=document.createElement("div");n.className="supriai-notification",n.innerHTML='\n      <div class="notification-content">\n        <div class="notification-title">'.concat(t,'</div>\n        <div class="notification-message">').concat(e,"</div>\n      </div>\n    "),document.body.appendChild(n),setTimeout(function(){n.classList.add("show")},100),setTimeout(function(){n.classList.remove("show"),setTimeout(function(){return n.remove()},300)},4e3)}},{key:"trackScrolling",value:function(){var t=this,e=0;window.addEventListener("scroll",function(){t.lastActivity=Date.now();var n=window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100;e=Math.max(e,n),t.scrollDepth=Math.round(e)})}},{key:"trackHighlights",value:function(){var t=this;document.addEventListener("mouseup",function(){t.lastActivity=Date.now();var e=window.getSelection(),n=e.toString().trim();n.length>10&&n.length<1e3&&(t.highlights.push({text:n,timestamp:Date.now(),context:t.getTextContext(e)}),t.saveHighlight(n))})}},{key:"trackActivity",value:function(){var t=this;["click","keydown","mousemove"].forEach(function(e){document.addEventListener(e,function(){t.lastActivity=Date.now(),"click"!==e&&"keydown"!==e||t.interactions++})})}},{key:"trackIdle",value:function(){var t=this;setInterval(function(){var e=Date.now()-t.lastActivity;t.isActive=!(e>6e4)},5e3)}},{key:"getTextContext",value:function(t){try{var e=t.getRangeAt(0).commonAncestorContainer;return(3===e.nodeType?e.parentNode:e).textContent.substring(0,500)}catch(t){return""}}},{key:"extractPageContext",value:function(){for(var t,e=document.title,n=window.location.href,o=window.location.hostname,i="",r=0,a=["article","main",'[role="main"]',".content",".post-content","#content"];r<a.length;r++){var c=a[r],s=document.querySelector(c);if(s){i=s.innerText.substring(0,5e3);break}}return i||(i=document.body.innerText.substring(0,5e3)),{title:e,url:n,domain:o,content:i,description:(null===(t=document.querySelector('meta[name="description"]'))||void 0===t?void 0:t.content)||"",headings:Array.from(document.querySelectorAll("h1, h2, h3")).slice(0,10).map(function(t){return t.innerText.trim()}),timestamp:Date.now(),timeSpent:Math.floor((Date.now()-this.startTime)/1e3),scrollDepth:this.scrollDepth,interactions:this.interactions,highlights:this.highlights}}},{key:"sendHeartbeat",value:(s=i(e().m(function t(){var n;return e().w(function(t){for(;;)switch(t.n){case 0:if(!document.hidden&&this.isActive){t.n=1;break}return console.log("â¸ï¸ Skipping heartbeat (page hidden or inactive)"),t.a(2);case 1:n=this.extractPageContext(),chrome.runtime.sendMessage({type:"CONTEXT_UPDATE",data:n}),chrome.runtime.sendMessage({type:"TRACK_LEARNING_ACTIVITY",data:{scrollDepth:this.scrollDepth/100,timeActive:Date.now()-this.startTime,interactions:this.interactions,isActive:this.isActive}});case 2:return t.a(2)}},t,this)})),function(){return s.apply(this,arguments)})},{key:"saveHighlight",value:(c=i(e().m(function t(n){return e().w(function(t){for(;;)switch(t.n){case 0:chrome.runtime.sendMessage({type:"SAVE_HIGHLIGHT",data:{text:n,url:window.location.href,title:document.title,timestamp:Date.now()}});case 1:return t.a(2)}},t)})),function(t){return c.apply(this,arguments)})},{key:"loadPreviousContext",value:(a=i(e().m(function t(){var n=this;return e().w(function(t){for(;;)switch(t.n){case 0:chrome.runtime.sendMessage({type:"GET_PREVIOUS_CONTEXT",url:window.location.href},function(t){t&&t.context&&n.showMemoryOverlay(t.context)});case 1:return t.a(2)}},t)})),function(){return a.apply(this,arguments)})},{key:"injectOverlay",value:function(){if(document.getElementById("supriai-overlay"))console.log("âœ“ Overlay already exists, skipping injection");else{var t=document.createElement("div");t.id="supriai-overlay",t.innerHTML='\n      <div class="supriai-icon" title="supriai Memory">\n        ðŸ’«\n      </div>\n      <div class="supriai-popup" style="display: none;">\n        <div class="supriai-popup-content">\n          <div class="supriai-loading">Loading memories...</div>\n        </div>\n      </div>\n    ',document.body.appendChild(t);var e=t.querySelector(".supriai-icon"),n=t.querySelector(".supriai-popup");e.addEventListener("click",function(){var t="none"!==n.style.display;n.style.display=t?"none":"block"})}}},{key:"showMemoryOverlay",value:function(t){var e=document.querySelector(".supriai-popup-content");if(e){var n=t.visits,o=t.lastVisit,i=t.totalTimeSpent,r=t.highlights,a=t.tags,c='<div class="supriai-memory">';if(n>1){if(c+='\n        <div class="memory-header">\n          <span class="memory-icon">ðŸ”®</span>\n          <span class="memory-title">Memory Recall</span>\n        </div>\n        <div class="memory-stat">\n          You\'ve been here <strong>'.concat(n," times</strong>\n        </div>\n      "),o){var s=this.formatTimeSince(o);c+='<div class="memory-stat">Last visit: <strong>'.concat(s,"</strong></div>")}if(i>60){var u=Math.floor(i/60);c+='<div class="memory-stat">Total time: <strong>'.concat(u," minutes</strong></div>")}r&&r.length>0&&(c+='<div class="memory-section">',c+='<div class="memory-section-title">Your highlights:</div>',r.slice(0,3).forEach(function(t){c+='<div class="memory-highlight">"'.concat(t.text.substring(0,100),'..."</div>')}),c+="</div>"),a&&a.length>0&&(c+='<div class="memory-section">',c+='<div class="memory-tags">',a.forEach(function(t){c+='<span class="memory-tag">'.concat(t,"</span>")}),c+="</div></div>")}else c+='\n        <div class="memory-header">\n          <span class="memory-icon">âœ¨</span>\n          <span class="memory-title">First Visit</span>\n        </div>\n        <div class="memory-stat">\n          This is your first time here. supriai is capturing context...\n        </div>\n      ';c+="</div>",e.innerHTML=c}}},{key:"formatTimeSince",value:function(t){var e=Math.floor((Date.now()-t)/1e3);return e<60?"just now":e<3600?"".concat(Math.floor(e/60)," minutes ago"):e<86400?"".concat(Math.floor(e/3600)," hours ago"):e<604800?"".concat(Math.floor(e/86400)," days ago"):e<2592e3?"".concat(Math.floor(e/604800)," weeks ago"):"".concat(Math.floor(e/2592e3)," months ago")}}],n&&r(t.prototype,n),o&&r(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,o,a,c,s}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){new c}):new c,window.addEventListener("beforeunload",function(){var t=(window.contextCapture||new c).extractPageContext();chrome.runtime.sendMessage({type:"PAGE_UNLOAD",data:t})})})();